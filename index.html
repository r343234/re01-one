import sys
from PyQt5.QtWidgets import QApplication, QMainWindow, QStatusBar, QLabel, QDockWidget, QWidget, QPushButton, QSlider, QVBoxLayout, QHBoxLayout, QMenu, QDialog
from PyQt5.QtCore import Qt, QTimer
from PyQt5.QtGui import QFont
from PyQt5.QtMultimedia import QSound

class VoiceControlDialog(QDialog):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("语音控制界面")
        self.setGeometry(200, 200, 300, 200)
        layout = QVBoxLayout()

        # 说明文字
        instruction_label = QLabel("按住下方按钮说话，松开后语音指令将被发送。")
        instruction_label.setStyleSheet("font-size: 14px; color: #333;")
        layout.addWidget(instruction_label)

        # 按住说话按钮
        self.speak_button = QPushButton("按住说话")
        self.speak_button.setStyleSheet("""
            QPushButton {
                background-color: #007BFF;
                color: white;
                border-radius: 5px;
                padding: 10px;
                border: none;
                box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton:pressed {
                background-color: #003d82;
                box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            }
        """)
        layout.addWidget(self.speak_button)

        self.setLayout(layout)

class GestureControlDialog(QDialog):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("手势控制界面")
        self.setGeometry(200, 200, 300, 200)
        layout = QVBoxLayout()
        label = QLabel("手势控制说明：\n可以通过特定手势控制无人机的飞行。\n例如：向上挥手，无人机会上升。")
        label.setStyleSheet("font-size: 14px; color: #333;")
        layout.addWidget(label)
        self.setLayout(layout)

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()

        # 顶部状态栏
        self.status_bar = QStatusBar()
        self.status_bar.setStyleSheet("background-color: #343A40; color: white; padding: 5px;")
        self.connection_label = QLabel("已连接")
        self.battery_label = QLabel("🔋 80%")
        self.wifi_label = QLabel("📶 Strong")
        self.mode_label = QLabel("手势控制中")
        self.status_bar.addWidget(self.connection_label)
        self.status_bar.addWidget(self.battery_label)
        self.status_bar.addWidget(self.wifi_label)
        self.status_bar.addWidget(self.mode_label)
        self.setStatusBar(self.status_bar)

        # 中央视频显示区域
        self.video_label = QLabel()
        self.video_label.setStyleSheet("background-color: #1E1E1E; margin: 10px; border-radius: 10px; border: 2px solid #343A40;")
        self.setCentralWidget(self.video_label)

        # 左侧控制面板
        self.left_dock = QDockWidget("控制面板")
        self.left_panel = QWidget()
        left_layout = QVBoxLayout()
        left_layout.setSpacing(10)
        left_layout.setContentsMargins(10, 10, 10, 10)

        # 基础控制按钮
        self.takeoff_btn = QPushButton("🛫 起飞")
        self.land_btn = QPushButton("🛬 降落")
        self.emergency_btn = QPushButton("🛑 紧急制动")
        self.hover_btn = QPushButton("⏸️ 悬停")
        self.launch_btn = QPushButton("✈️ 抛飞")
        for btn in [self.takeoff_btn, self.land_btn, self.emergency_btn, self.hover_btn, self.launch_btn]:
            btn.setStyleSheet("""
                QPushButton {
                    background-color: #28A745;
                    color: white;
                    border-radius: 5px;
                    padding: 10px;
                    border: none;
                    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                }
                QPushButton:hover {
                    background-color: #218838;
                }
                QPushButton:pressed {
                    background-color: #1e7e34;
                    box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
                }
            """)
            left_layout.addWidget(btn)

        # 模式切换
        self.gesture_switch = QPushButton("👐 手势控制开关")
        self.gesture_switch.clicked.connect(self.show_gesture_control_dialog)
        self.voice_switch = QPushButton("🎤 语音控制开关")
        self.voice_switch.clicked.connect(self.show_voice_control_dialog)
        self.green_ball_tracking = QPushButton("绿球跟踪🔵")
        self.face_tracking = QPushButton("人脸跟踪👤")
        for btn in [self.gesture_switch, self.voice_switch, self.green_ball_tracking, self.face_tracking]:
            btn.setStyleSheet("""
                QPushButton {
                    background-color: #007BFF;
                    color: white;
                    border-radius: 5px;
                    padding: 10px;
                    border: none;
                    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                }
                QPushButton:hover {
                    background-color: #0056b3;
                }
                QPushButton:pressed {
                    background-color: #003d82;
                    box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
                }
            """)
            left_layout.addWidget(btn)

        self.left_panel.setLayout(left_layout)
        self.left_dock.setWidget(self.left_panel)
        self.addDockWidget(Qt.LeftDockWidgetArea, self.left_dock)

        # 右侧参数面板
        self.right_dock = QDockWidget("参数设置")
        self.right_panel = QWidget()
        right_layout = QVBoxLayout()
        right_layout.setSpacing(10)
        right_layout.setContentsMargins(10, 10, 10, 10)

        # 速度调节
        speed_label = QLabel("速度调节：")
        speed_label.setStyleSheet("font-size: 14px; color: white;")
        speed_layout = QHBoxLayout()
        self.speed_slider = QSlider(Qt.Horizontal)
        self.speed_slider.setRange(0, 100)
        self.speed_value_label = QLabel("0%")
        self.speed_value_label.setStyleSheet("font-size: 14px; color: white;")
        speed_layout.addWidget(self.speed_slider)
        speed_layout.addWidget(self.speed_value_label)
        right_layout.addWidget(speed_label)
        right_layout.addLayout(speed_layout)

        # 步长设置
        step_label = QLabel("步长设置：")
        step_label.setStyleSheet("font-size: 14px; color: white;")
        step_layout = QHBoxLayout()
        self.step_slider = QSlider(Qt.Horizontal)
        self.step_slider.setRange(10, 100)
        self.step_value_label = QLabel("10cm")
        self.step_value_label.setStyleSheet("font-size: 14px; color: white;")
        step_layout.addWidget(self.step_slider)
        step_layout.addWidget(self.step_value_label)
        right_layout.addWidget(step_label)
        right_layout.addLayout(step_layout)

        # 延时时间设置
        delay_label = QLabel("延时时间设置：")
        delay_label.setStyleSheet("font-size: 14px; color: white;")
        delay_layout = QHBoxLayout()
        self.delay_slider = QSlider(Qt.Horizontal)
        self.delay_slider.setRange(1, 10)
        self.delay_value_label = QLabel("1s")
        self.delay_value_label.setStyleSheet("font-size: 14px; color: white;")
        delay_layout.addWidget(self.delay_slider)
        delay_layout.addWidget(self.delay_value_label)
        self.delay_slider.valueChanged.connect(self.update_delay_label)
        right_layout.addWidget(delay_label)
        right_layout.addLayout(delay_layout)

        # 高级设置
        advanced_label = QLabel("高级设置：")
        advanced_label.setStyleSheet("font-size: 14px; color: white;")
        self.posture_switch = QPushButton("体态控制开关")
        self.capture_btn = QPushButton("📸⏺️ 拍照/录像")
        self.capture_btn.setContextMenuPolicy(Qt.CustomContextMenu)
        self.capture_btn.customContextMenuRequested.connect(self.show_capture_menu)
        for btn in [self.posture_switch, self.capture_btn]:
            btn.setStyleSheet("""
                QPushButton {
                    background-color: #FFC107;
                    color: white;
                    border-radius: 5px;
                    padding: 10px;
                    border: none;
                    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                }
                QPushButton:hover {
                    background-color: #e0a800;
                }
                QPushButton:pressed {
                    background-color: #d39e00;
                    box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
                }
            """)
        right_layout.addWidget(advanced_label)
        right_layout.addWidget(self.posture_switch)
        right_layout.addWidget(self.capture_btn)

        self.right_panel.setLayout(right_layout)
        self.right_dock.setWidget(self.right_panel)
        self.addDockWidget(Qt.RightDockWidgetArea, self.right_dock)

        # 底部日志栏
        self.log_label = QLabel("系统消息将显示在这里")
        self.log_label.setStyleSheet("font-size: 14px; color: white; padding: 5px;")
        self.statusBar().addPermanentWidget(self.log_label)

        # 设置样式
        font = QFont()
        font.setFamily("Segoe UI")
        font.setPointSize(10)
        self.setFont(font)

        self.setStyleSheet("""
            QMainWindow {
                background-color: #212529;
                color: #FFFFFF;
            }
        """)

        self.setGeometry(100, 100, 800, 600)
        self.setWindowTitle("无人机控制界面")
        self.show()

    def update_delay_label(self):
        value = self.delay_slider.value()
        self.delay_value_label.setText(f"{value}s")

    def show_capture_menu(self, pos):
        menu = QMenu()
        immediate_action = menu.addAction("立即拍照")
        delayed_action = menu.addAction("延时拍照")
        action = menu.exec_(self.capture_btn.mapToGlobal(pos))
        if action == immediate_action:
            self.take_photo()
        elif action == delayed_action:
            delay = self.delay_slider.value()
            QTimer.singleShot(delay * 1000, self.take_photo)
            self.log_label.setText(f"将在 {delay} 秒后拍照...")

    def take_photo(self):
        try:
            # 模拟拍照音效
            QSound.play("camera_shutter.wav")
            self.log_label.setText("拍照成功！照片已保存。")
        except Exception as e:
            self.log_label.setText(f"拍照失败：{str(e)}")

    def show_voice_control_dialog(self):
        dialog = VoiceControlDialog()
        dialog.exec_()

    def show_gesture_control_dialog(self):
        dialog = GestureControlDialog()
        dialog.exec_()

if __name__ == '__main__':
    app = QApplication(sys.argv)
    window = MainWindow()
    sys.exit(app.exec_())
